# 数据工厂操作与统计看板 PRD (V0.1)

## 文档信息
- **产品名称**: 数据工厂操作与统计看板
- **版本**: V0.1 (单一操作者免鉴权使用)
- **最后更新**: 2025-11-05
- **面向读者**: 产品、研发(前端 / 后端 / DevOps)、数据治理、运维
- **状态描述**: 需求基线，待未决事项确认后进入设计开发

---

## 1. 产品概述
数据工厂操作与统计看板整合数据工厂的操作管理、实时监控与历史统计能力。产品以 Vue3 SPA 形态提供统一入口，通过 FastAPI 后端聚合 Postgres 数据，连接模型服务与任务队列的 gRPC 能力，满足单一操作者对流程配置、任务执行、指标监控的全链路诉求，并可通过 npm 或 Docker 快速部署。

## 2. 目标与衡量指标
- 覆盖至少 80% 数据工厂核心操作流程。
- 本地 / npm / Docker 启动时间不超过 10 分钟。
- 实时指标刷新延迟不超过 5 分钟。
- 历史对比支持日 / 周 / 月粒度。
- gRPC 调用成功率不少于 95%，REST API P95 延迟不超过 1s。
- 首屏渲染小于 3s，支持同时 5-10 名操作者。

## 3. 用户与使用场景
- **主要角色**: 数据工厂操作者(单人或值守小组)、数据治理负责人、技术支持。
- **核心场景**:
  1. 配置或导入数据源、数据集与流程模板，发起模型运行任务。
  2. 监控流程状态、告警与吞吐表现，并进行实时调整。
  3. 查看历史指标对比，导出 CSV 或 PNG 报表，用于复盘与汇报。
  4. 配置模型调用参数、质检策略、发布与归档。

## 4. 功能范围
### 4.1 必须实现
- 数据源与数据集管理。
- 流程编排: 自由阶段配置、模板导入导出、流程校验。
- 任务监控: 实时状态、指标、告警提醒(UI 内提示)。
- 模型调用配置、质检验收、发布归档。
- 统计看板: 实时与历史对比(KPI 卡、阶段表、柱状、折线、饼图)，支持筛选与导出。
- 系统配置 GUI，免鉴权默认开启，可通过配置切换。
- REST API 覆盖配置、模板、流程、任务、指标、告警；保留日志接口占位(UI 不展示历史日志)。

### 4.2 后续迭代候选
- WebSocket 实时推送(首版可使用 60s 轮询)。
- 告警阈值策略可视化配置。
- 模板版本与差异管理工具。

## 5. 统计看板设计
- **核心元素**: KPI 卡片、阶段数据表、阶段对比柱状图、Token 指标柱状图、实时吞吐折线、历史对比折/柱、请求结构饼图。
- **筛选维度**: 时间(今日 / 7 日 / 30 日 / 自定义)、项目、模型版本、阶段模板。
- **导出能力**: 指标数据 CSV，图表 PNG。导出在前端完成，后端提供数据接口。
- **刷新策略**: 默认 60 秒轮询，后续可升级为 WebSocket。

## 6. 数据与接口要求
- 仅 FastAPI 后端直接访问 Postgres，其余服务通过 REST 或 gRPC。
- **核心数据表建议**: `data_sources`、`datasets`、`pipelines`、`pipeline_stages`、`pipeline_templates`、`tasks`、`task_runs`、`metrics_summary`、`tokens_usage`、`alerts`、`config`。
- 模板以 JSON 存储，日志接口保留但不做落库。
- 指标服务需支持同比/环比聚合与历史窗口查询。
- gRPC 客户端对接模型服务与任务队列，需要共享 proto 仓库。

## 7. 技术要求
- **前端**: Vue3 + Vite + TypeScript + Pinia + Axios，图表使用 Chart.js 或 ECharts；封装 API SDK；预留 i18n 能力。
- **后端**: FastAPI + SQLAlchemy (Async) / asyncpg + Pydantic；统一配置加载(`config.json` + `.env`)，支持热更新；实现指标缓存策略。
- **gRPC**: 基于 `grpcio` 封装模型服务与任务队列调用，提供统一异常处理。
- **部署**: 多阶段 Docker 构建(Node 构建前端后复制到 Python 镜像)；`docker-compose` 示例包含 Postgres 与 Redis(队列或缓存)。
- **工具链**: npm scripts(`dev` / `build`)，`uvicorn` 启动脚本，配套单元、集成与端到端测试计划。

## 8. 性能与质量保障
- 首屏渲染小于 3s，资源按需拆分并启用 gzip/缓存。
- REST API P95 小于 1s，指标计算使用缓存(内存或 Redis)和异步任务。
- 支持 5-10 名并发操作者；gRPC 请求具备重试与超时控制。
- 指标聚合需具备数据延迟或缺失时的兜底策略。

## 9. 交互与体验
- 界面突出实时状态与告警，高优先级信息显著呈现。
- 告警在 UI 内高亮提醒，并预留后续扩展通知渠道。
- 导出操作在前端执行，可选在后端记录审计。
- 满足基本可访问性(颜色对比、键盘可操作)。

## 10. 部署与运维
- 开发模式: `npm run dev`(前端)，`uvicorn app.main:app --reload`(后端)。
- Docker 化: 多阶段 Dockerfile 与 docker-compose(应用、Postgres、Redis)。
- 配置示例: `config.example.json`、`.env.example`，覆盖数据库、gRPC、缓存、告警阈值等。
- 提供演示数据脚本，用于快速写入样例数据。

## 11. 未决事项
1. 模型与任务队列的 gRPC 接口定义(方法、鉴权、超时)。
2. 阶段模板版本管理策略(版本号、变更流程)。
3. 历史对比默认时间窗口(建议 7 日，待确认)。
4. 告警阈值策略与可视化配置方式。
5. 首版是否实现 WebSocket 推送或延后迭代。

## 12. 技术实现路径与里程碑
1. 架构拆分: 前端(Vue3 Vite)、后端(FastAPI)、共享 proto 仓库、数据库初始化脚本。
2. 数据库设计: 确认表结构、关系、索引，生成 Alembic 迁移。
3. 后端开发: 项目骨架、SQLAlchemy async、仓储与服务层、REST API、gRPC 客户端、指标聚合与缓存、配置加载。
4. 前端开发: 初始化项目、路由/布局/Pinia 架构、模块化页面、API SDK、图表组件、导出能力、国际化占位。
5. 联调与测试: 单元与集成测试、端到端验证、性能基准、异常流程演练。
6. 部署与交付: 多阶段 Dockerfile、docker-compose、CI/CD(可选)、README 与上线检查清单。

## 13. 风险与依赖
- gRPC 接口定义延迟会阻塞任务调度与模型配置开发。
- 指标数据延迟或不一致需要缓存过期与回放兜底策略。
- 免鉴权仅适用于单一操作者，需预留后续鉴权扩展点。
- Docker 镜像体积与构建时间需控制，避免部署缓慢。

## 14. 任务清单 (执行节奏建议)
1. 定稿 PRD: 确认功能范围、指标、未决事项。
2. 设计数据模型: 输出 Postgres ERD，编写 Alembic 迁移。
3. 搭建 FastAPI 骨架: 集成 SQLAlchemy / asyncpg、Pydantic、配置加载。
4. 实现核心 REST API: 配置、模板、流程、任务、指标、告警端点。
5. 集成 gRPC 客户端: 对接模型服务与任务队列 proto。
6. 规划指标聚合逻辑: 实时与历史对比、缓存策略。
7. 初始化 Vue3 + Vite + TS 前端: 路由、Pinia、Axios 封装。
8. 开发页面: 操作总览、数据源/数据集、流程编排、任务监控、模型配置、质检、发布、统计看板。
9. 实现图表组件与导出: Chart.js/ECharts、CSV/PNG。
10. 完成模板导入/导出与流程校验逻辑。
11. 配置 npm 本地开发脚本与文档。
12. 编写多阶段 Dockerfile 与 docker-compose，验证 Docker 启动。
13. 准备联调与测试方案: 单元、集成、端到端。
14. 整理 README、配置示例、上线检查清单。

---

> 本文档用于固化数据工厂操作与统计看板的需求基线，并指导后续设计、开发与交付。未决事项需在开发启动前评审确认。
